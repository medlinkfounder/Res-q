<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ResQ 112 - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    body{font-family:'Inter',sans-serif;background:#0a0a1a;color:#e0e0e0}
    #ripple-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0}
    .content-overlay{position:relative;z-index:2;min-height:100vh;background:radial-gradient(circle,rgba(10,10,26,0.6),#0a0a1a 80%);backdrop-filter:blur(6px);}
    .glass-card{background:rgba(255,255,255,0.05);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1);padding:20px;border-radius:16px;transition:all .3s ease}
    .glass-card:hover{box-shadow:0 0 10px #00ffff,0 0 25px #00ffff;}
    .glow-button{transition:all .3s ease}
    .glow-button:hover{box-shadow:0 0 10px #00ffff,0 0 25px #00ffff;}
    /* üî¥ Special red neon for SOS */
    .sos-button{transition:all .3s ease}
    .sos-button:hover{box-shadow:0 0 15px #ff0000,0 0 35px #ff0000;}
    /* pulsing active SOS */
    .sos-active {
      animation: sosPulse 1.6s infinite;
      box-shadow: 0 0 20px #ff3b3b, 0 0 45px #ff3b3b;
    }
    @keyframes sosPulse {
      0% { box-shadow: 0 0 10px #ff3b3b; transform: scale(1); }
      50% { box-shadow: 0 0 30px #ff3b3b; transform: scale(1.02); }
      100% { box-shadow: 0 0 10px #ff3b3b; transform: scale(1); }
    }

    /* small status label styling for active key display (if needed) */
    .sos-status { margin-top:8px; color:#ffb3b3; font-weight:600; text-align:center; }

  </style>
</head>
<body>
<canvas id="ripple-canvas"></canvas>

<div class="content-overlay flex flex-col min-h-screen">
  <!-- Header -->
  <header class="p-4 bg-black/30 flex justify-between items-center">
    <div class="flex items-center space-x-2">
      <img src="logo.png.png" alt="logo" class="h-10 w-10"/>
      <span class="text-2xl font-bold text-white">ResQ 112</span>
    </div>
    <select id="languageSwitcher" class="bg-black/50 text-white p-2 rounded">
      <option value="en">English</option>
      <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
      <option value="as">‡¶Ö‡¶∏‡¶Æ‡ßÄ‡¶Ø‡¶º‡¶æ</option>
    </select>
  </header>

  <!-- SOS Button -->
  <div class="flex justify-center mt-8">
    <button id="sosBtn" class="w-40 h-40 bg-red-600 text-white text-2xl font-bold rounded-full sos-button">SOS</button>
  </div>
  <div class="flex justify-center mt-4">
    <button id="stopBtn" class="px-6 py-2 bg-gray-600 text-white rounded-lg glow-button hidden">Stop SOS</button>
  </div>

  <div id="sosKeyLabel" class="flex justify-center"><div class="sos-status" id="sosKeyText"></div></div>

  <!-- Dashboard Blocks -->
  <main class="container mx-auto px-4 mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <a href="profile.html" class="glass-card p-6 rounded-xl">
      <h3 class="text-xl font-bold mb-2" data-i18n="profile_title">üë§ Profile</h3>
      <p data-i18n="profile_desc">View and update your details.</p>
    </a>
    <a href="wearable.html" class="glass-card p-6 rounded-xl">
      <h3 class="text-xl font-bold mb-2" data-i18n="wearable_title">‚åö Wearable & Emergency Contacts</h3>
      <p data-i18n="wearable_desc">Connect devices and manage your emergency numbers.</p>
    </a>
    <a href="map.html" class="glass-card p-6 rounded-xl">
      <h3 class="text-xl font-bold mb-2" data-i18n="map_title">üó∫Ô∏è Map</h3>
      <p data-i18n="map_desc">Track your location and nearby safe zones.</p>
    </a>
    <a href="contacts.html" class="glass-card p-6 rounded-xl">
      <h3 class="text-xl font-bold mb-2" data-i18n="contacts_title">üìû Emergency Numbers</h3>
      <p data-i18n="contacts_desc">Manage and call your emergency numbers.</p>
    </a>
    <a href="askai.html" class="glass-card p-6 rounded-xl">
      <h3 class="text-xl font-bold mb-2" data-i18n="askai_title">ü§ñ Ask AI</h3>
      <p data-i18n="askai_desc">Get real-time AI assistance.</p>
    </a>
    <a href="support.html" class="glass-card p-6 rounded-xl">
      <h3 class="text-xl font-bold mb-2" data-i18n="support_title">üí¨ Contact Support</h3>
      <p data-i18n="support_desc">Reach out to support team.</p>
    </a>
  </main>
</div>

<!-- Hidden audio element (put sos.mp3 in same folder) -->
<audio id="sosAudio" src="sos.mp3" loop preload="auto"></audio>

<script>
// Firebase config (unchanged from yours)
const firebaseConfig={
  apiKey:"AIzaSyBcLtaRPt6hTo4aEFRvcBwNq5-00soEjB4",
  authDomain:"sos-c1499.firebaseapp.com",
  databaseURL:"https://sos-c1499-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"sos-c1499",
  storageBucket:"sos-c1499.firebasestorage.app",
  messagingSenderId:"1008729495848",
  appId:"1:1008729495848:web:7d6c7d3a6047e2736e981d",
  measurementId:"G-JGBY3ZZPGC"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// UI elements
const sosBtn=document.getElementById("sosBtn");
const stopBtn=document.getElementById("stopBtn");
const sosAudio=document.getElementById("sosAudio");
const sosKeyText=document.getElementById("sosKeyText");

// runtime state
let currentSosKey = null;
let watchId = null;

// Helper: read user info from localStorage (from your login)
function getUserInfo() {
  const name = localStorage.getItem("userName") || localStorage.getItem("name") || "Unknown";
  const id = localStorage.getItem("userId") || localStorage.getItem("id") || localStorage.getItem("aadhar") || localStorage.getItem("passport") || "unknown";
  const method = localStorage.getItem("idMethod") || localStorage.getItem("method") || "";
  const phone = localStorage.getItem("phone") || localStorage.getItem("mobile") || "";
  return { name, id, method, phone };
}

// Start SOS
async function startSOS() {
  // UI toggle
  sosBtn.classList.add("hidden");
  stopBtn.classList.remove("hidden");
  sosBtn.classList.add("sos-active");

  // Play audio (user click allows playback)
  try {
    sosAudio.currentTime = 0;
    await sosAudio.play();
  } catch (err) {
    console.warn("Audio play blocked or failed:", err);
  }

  if (!navigator.geolocation) {
    alert("Geolocation not available on this device.");
    return;
  }

  const user = getUserInfo();
  // get an immediate location first then start watch
  navigator.geolocation.getCurrentPosition(async (pos) => {
    try {
      const refPush = db.ref('sos').push();
      currentSosKey = refPush.key;
      localStorage.setItem('currentSosKey', currentSosKey);
      const payload = {
        userId: user.id,
        name: user.name,
        method: user.method || "",
        phone: user.phone || "",
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        timestamp: Date.now(),
        status: "active"
      };
      await refPush.set(payload);
      sosKeyText.innerText = `Active SOS: ${currentSosKey}`;
    } catch (err) {
      console.error("Failed to create SOS entry:", err);
    }

    // start watch to update location continuously
    watchId = navigator.geolocation.watchPosition((p) => {
      if (!currentSosKey) return;
      const update = {
        lat: p.coords.latitude,
        lng: p.coords.longitude,
        timestamp: Date.now()
      };
      db.ref('sos/' + currentSosKey).update(update).catch(e => console.error("update failed", e));
    }, (err) => {
      console.warn("watchPosition error:", err);
    }, { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 });

  }, (err) => {
    console.error("getCurrentPosition failed:", err);
    alert("Could not get location: " + err.message);
  }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
}

// Stop SOS: stop audio, stop watch, archive record
async function stopSOS() {
  // UI toggle
  sosBtn.classList.remove("hidden");
  stopBtn.classList.add("hidden");
  sosBtn.classList.remove("sos-active");
  sosKeyText.innerText = "";

  // stop audio
  try {
    sosAudio.pause();
    sosAudio.currentTime = 0;
  } catch (err) {
    console.warn("Failed to stop audio:", err);
  }

  // stop watch
  if (watchId !== null) {
    try { navigator.geolocation.clearWatch(watchId); } catch(e) {}
    watchId = null;
  }

  // move entry to archived_sos and remove from active
  const key = currentSosKey || localStorage.getItem('currentSosKey');
  if (!key) {
    alert("No active SOS found to stop.");
    return;
  }

  try {
    const snap = await db.ref('sos/' + key).once('value');
    const data = snap.val();
    if (!data) {
      // nothing to archive; clear key
      currentSosKey = null;
      localStorage.removeItem('currentSosKey');
      alert("SOS stopped (no data to archive).");
      return;
    }
    // add stop metadata
    data.stoppedAt = Date.now();
    data.status = "archived";
    // write to archived node (use same key)
    await db.ref('archived_sos/' + key).set(data);
    // remove from active
    await db.ref('sos/' + key).remove();
    currentSosKey = null;
    localStorage.removeItem('currentSosKey');
    alert("üõë SOS stopped and archived.");
  } catch (err) {
    console.error("Error archiving SOS:", err);
    alert("Error while stopping SOS. See console for details.");
  }
}

// Hook event listeners
sosBtn.addEventListener("click", startSOS);
stopBtn.addEventListener("click", stopSOS);

// If a key left in localStorage (from accidental reload), show label and resume audio? we will only display
window.addEventListener("load", () => {
  const existing = localStorage.getItem('currentSosKey');
  if (existing) {
    currentSosKey = existing;
    sosKeyText.innerText = `Active SOS: ${currentSosKey}`;
    // Show stop button so user can stop and archive it
    sosBtn.classList.add("hidden");
    stopBtn.classList.remove("hidden");
    sosBtn.classList.add("sos-active");
  }
});

// Translations (unchanged)
const translations={
  en:{
    sos_btn:"SOS",
    stop_btn:"Stop SOS",
    profile_title:"üë§ Profile",
    profile_desc:"View and update your details.",
    wearable_title:"‚åö Wearable & Emergency Contacts",
    wearable_desc:"Connect devices and manage your emergency numbers.",
    map_title:"üó∫Ô∏è Map",
    map_desc:"Track your location and nearby safe zones.",
    contacts_title:"File an FIR",
    contacts_desc:"Manage and call your emergency numbers.",
    askai_title:"ü§ñ Ask AI",
    askai_desc:"Get real-time AI assistance.",
    support_title:"üí¨ Contact Support",
    support_desc:"Reach out to support team."
  },
  hi:{
    sos_btn:"‡§è‡§∏‡§ì‡§è‡§∏",
    stop_btn:"‡§è‡§∏‡§ì‡§è‡§∏ ‡§∞‡•ã‡§ï‡•á‡§Ç",
    profile_title:"üë§ ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤",
    profile_desc:"‡§Ö‡§™‡§®‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§¶‡•á‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§",
    wearable_title:"‚åö ‡§µ‡§ø‡§Ø‡§∞‡•á‡§¨‡§≤ ‡§î‡§∞ ‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï",
    wearable_desc:"‡§Ö‡§™‡§®‡•á ‡§µ‡§ø‡§Ø‡§∞‡•á‡§¨‡§≤ ‡§â‡§™‡§ï‡§∞‡§£ ‡§î‡§∞ ‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§",
    map_title:"üó∫Ô∏è ‡§®‡§ï‡•ç‡§∂‡§æ",
    map_desc:"‡§Ö‡§™‡§®‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§î‡§∞ ‡§™‡§æ‡§∏ ‡§ï‡•á ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§ü‡•ç‡§∞‡•à‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§",
    contacts_title:"üìû ‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï",
    contacts_desc:"‡§Ö‡§™‡§®‡•á ‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç‡•§",
    askai_title:"ü§ñ ‡§è‡§Ü‡§à ‡§∏‡•á ‡§™‡•Ç‡§õ‡•á‡§Ç",
    askai_desc:"‡§∞‡§ø‡§Ø‡§≤-‡§ü‡§æ‡§á‡§Æ ‡§è‡§Ü‡§à ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§",
    support_title:"üí¨ ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç",
    support_desc:"‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ü‡•Ä‡§Æ ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§"
  },
  as:{
    sos_btn:"‡¶è‡¶∏‡¶ì‡¶è‡¶õ",
    stop_btn:"‡¶è‡¶∏‡¶ì‡¶è‡¶õ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡ß∞‡¶ï",
    profile_title:"üë§ ‡¶™‡ßç‡ß∞‚Äô‡¶´‡¶æ‡¶á‡¶≤",
    profile_desc:"‡¶Ü‡¶™‡ßã‡¶®‡¶æ‡ß∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶ö‡¶æ‡¶ì‡¶ï ‡¶Ü‡ß∞‡ßÅ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡ß∞‡¶ï‡•§",
    wearable_title:"‚åö ‡¶™‡ß∞‡¶ø‡¶ß‡¶æ‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶Ü‡ß∞‡ßÅ ‡¶ú‡¶∞‡ßÅ‡ß∞‡ßÄ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó",
    wearable_desc:"‡¶Ü‡¶™‡ßã‡¶®‡¶æ‡ß∞ ‡¶™‡ß∞‡¶ø‡¶ß‡¶æ‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶ö ‡¶Ü‡ß∞‡ßÅ ‡¶ú‡¶∞‡ßÅ‡ß∞‡ßÄ ‡¶®‡¶Æ‡ßç‡¶¨‡ß∞ ‡¶¨‡ßç‡¶Ø‡ß±‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶ï‡ß∞‡¶ï‡•§",
    map_title:"üó∫Ô∏è ‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡ß∞",
    map_desc:"‡¶Ü‡¶™‡ßã‡¶®‡¶æ‡ß∞ ‡¶Ö‡ß±‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶Ü‡ß∞‡ßÅ ‡¶ì‡¶ö‡ß∞‡ß∞ ‡¶∏‡ßÅ‡ß∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶∏‡ß∞‡¶£ ‡¶ï‡ß∞‡¶ï‡•§",
    contacts_title:"üìû ‡¶ú‡¶∞‡ßÅ‡ß∞‡ßÄ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó",
    contacts_desc:"‡¶Ü‡¶™‡ßã‡¶®‡¶æ‡ß∞ ‡¶ú‡¶∞‡ßÅ‡ß∞‡ßÄ ‡¶®‡¶Æ‡ßç‡¶¨‡ß∞ ‡¶¨‡ßç‡¶Ø‡ß±‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶ï‡ß∞‡¶ï ‡¶Ü‡ß∞‡ßÅ ‡¶ï‡¶≤ ‡¶ï‡ß∞‡¶ï‡•§",
    askai_title:"ü§ñ ‡¶è‡¶Ü‡¶á‡¶ï ‡¶™‡ßç‡ß∞‡¶∂‡ßç‡¶® ‡¶ï‡ß∞‡¶ï",
    askai_desc:"‡ß∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶è‡¶Ü‡¶á ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º ‡¶™‡ßç‡ß∞‡¶æ‡¶™‡ßç‡¶§ ‡¶ï‡ß∞‡¶ï‡•§",
    support_title:"üí¨ ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡ß∞ ‡¶∏‡ßà‡¶§‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡ß∞‡¶ï",
    support_desc:"‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶ï ‡¶¶‡¶≤‡ßá‡ß∞‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡ß∞‡¶ï‡•§"
  }
};

const switcher=document.getElementById("languageSwitcher");
function updateLanguage(lang){
  localStorage.setItem("lang",lang);
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key=el.getAttribute("data-i18n");
    if(translations[lang] && translations[lang][key]){
      el.innerText=translations[lang][key];
    }
  });
  // keep button text in sync
  sosBtn.innerText=translations[lang].sos_btn;
  stopBtn.innerText=translations[lang].stop_btn;
}
switcher.addEventListener("change",e=>updateLanguage(e.target.value));
window.addEventListener("load",()=>{
  const savedLang=localStorage.getItem("lang")||"en";
  switcher.value=savedLang;
  updateLanguage(savedLang);
});

// Ripple background
const canvas=document.getElementById("ripple-canvas"),ctx=canvas.getContext("2d");
canvas.width=innerWidth;canvas.height=innerHeight;
let ripples=[];
class Ripple{constructor(x,y){this.x=x;this.y=y;this.radius=0;this.alpha=1;}
update(){this.radius+=1.5;this.alpha-=0.01;}
draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,2*Math.PI);
ctx.strokeStyle=`rgba(0,255,255,${this.alpha})`;ctx.stroke();}}
function animate(){ctx.clearRect(0,0,canvas.width,canvas.height);
ripples.forEach((r,i)=>{r.update();r.draw();if(r.alpha<=0)ripples.splice(i,1);});
requestAnimationFrame(animate);}
animate();
addEventListener("mousemove",e=>ripples.push(new Ripple(e.clientX,e.clientY)));
addEventListener("resize",()=>{canvas.width=innerWidth;canvas.height=innerHeight});
</script>
</body>
</html>
